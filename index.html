<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIoT 手機感測器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; line-height: 1.6; }
        .box { border: 2px solid #ddd; padding: 15px; border-radius: 10px; margin: 10px 0; }
        button { padding: 20px; font-size: 1.2em; width: 100%; background: #28a745; color: white; border: none; border-radius: 10px; }
        #debug { color: #888; font-size: 0.8em; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>AIoT 感測器傳送門</h1>
    
    <button id="startBtn">1. 點擊授權並連線</button>
    
    <div class="box">
        <p>連線狀態：<span id="status" style="color:red">未連線</span></p>
        <p>X: <span id="x">0</span> | Y: <span id="y">0</span> | Z: <span id="z">0</span></p>
    </div>

    <div id="debug">系統日誌：等待操作...</div>

    <script>
        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug');
        const topic = "iot/myname/accel"; // 務必確認這裡的名稱

        // 使用 WSS (加密 WebSocket) 確保在 HTTPS 下運作
        let client = new Paho.MQTT.Client("wss://broker.emqx.io:8084/mqtt", "js_client_" + Math.random().toString(16).substr(2, 8));

        document.getElementById('startBtn').onclick = async function() {
            debugLog("嘗試獲取感測器權限...");

            // --- 核心：權限請求邏輯 ---
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS 裝置
                try {
                    const response = await DeviceMotionEvent.requestPermission();
                    if (response === 'granted') {
                        startSensorAndMQTT();
                    } else {
                        debugLog("權限被拒絕 (iOS)");
                    }
                } catch (e) {
                    debugLog("權限請求出錯: " + e);
                }
            } else {
                // Android 或其他裝置
                debugLog("非 iOS 裝置，直接啟動...");
                startSensorAndMQTT();
            }
        };

        function debugLog(msg) {
            debugEl.innerText = "系統日誌：" + msg;
            console.log(msg);
        }

        function startSensorAndMQTT() {
            // 先啟動感測器監聽，確保數字會動
            window.addEventListener('devicemotion', (event) => {
                let acc = event.accelerationIncludingGravity;
                if (acc) {
                    document.getElementById('x').innerText = acc.x ? acc.x.toFixed(2) : "0";
                    document.getElementById('y').innerText = acc.y ? acc.y.toFixed(2) : "0";
                    document.getElementById('z').innerText = acc.z ? acc.z.toFixed(2) : "0";
                    
                    // 如果已連線，則發送數據
                    if (client.isConnected()) {
                        let payload = JSON.stringify({ x: acc.x, y: acc.y, z: acc.z });
                        let message = new Paho.MQTT.Message(payload);
                        message.destinationName = topic;
                        client.send(message);
                    }
                }
            }, true);

            // 啟動 MQTT 連線
            debugLog("正在連線至 MQTT Broker...");
            client.connect({
                onSuccess: () => {
                    statusEl.innerText = "已連線";
                    statusEl.style.color = "green";
                    debugLog("連線成功，數據傳送中...");
                },
                onFailure: (e) => {
                    debugLog("連線失敗: " + e.errorMessage);
                },
                useSSL: true, // 重要：HTTPS 網頁必須用 SSL
                timeout: 10
            });
        }
    </script>
</body>
</html>
